<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>geo_new.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3-20001105 on Sun Mar 4 23:32:44 2001 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>geo_new.c</h1><div class="fragment"><pre>00001 <font class="comment">/**********************************************************************</font>
00002 <font class="comment"> *</font>
00003 <font class="comment"> *  geo_new.c  -- Public routines for GEOTIFF GeoKey access.</font>
00004 <font class="comment"> *</font>
00005 <font class="comment"> *    Written By: Niles D. Ritter.</font>
00006 <font class="comment"> *</font>
00007 <font class="comment"> *  copyright (c) 1995   Niles D. Ritter</font>
00008 <font class="comment"> *</font>
00009 <font class="comment"> *  Permission granted to use this software, so long as this copyright</font>
00010 <font class="comment"> *  notice accompanies any products derived therefrom.</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *    20 June, 1995      Niles D. Ritter         New</font>
00013 <font class="comment"> *    7 July,  1995      Greg Martin             Fix index</font>
00014 <font class="comment"> *</font>
00015 <font class="comment"> **********************************************************************/</font>
00016 
00017 <font class="preprocessor">#include "geotiffio.h"</font>   <font class="comment">/* public interface        */</font>
00018 <font class="preprocessor">#include "geo_tiffp.h"</font> <font class="comment">/* external TIFF interface */</font>
00019 <font class="preprocessor">#include "geo_keyp.h"</font>  <font class="comment">/* private interface       */</font>
00020 
00021 <font class="comment">/* private local routines */</font>
00022 <font class="keyword">static</font> <font class="keywordtype">int</font> ReadKey(GTIF* gt, KeyEntry* entptr,GeoKey* keyptr);
00023 
00024 <font class="comment">/**********************************************************************</font>
00025 <font class="comment"> *</font>
00026 <font class="comment"> *                        Public Routines</font>
00027 <font class="comment"> *</font>
00028 <font class="comment"> **********************************************************************/</font>
00029 
00030 
00051 GTIF* <a class="code" href="geotiff_h.html#a18">GTIFNew</a>(<font class="keywordtype">void</font> *tif)<font class="keyword"></font>
00052 <font class="keyword"></font>{
00053         GTIF* gt=(GTIF*)0;
00054         <font class="keywordtype">int</font> count,bufcount,index;
00055         GeoKey *keyptr;
00056         pinfo_t *data;
00057         KeyEntry *entptr;
00058         KeyHeader *header;
00059         
00060         gt = (GTIF*)_GTIFcalloc( <font class="keyword">sizeof</font>(GTIF));
00061         <font class="keywordflow">if</font> (!gt) <font class="keywordflow">goto</font> failure;  
00062         
00063         <font class="comment">/* install TIFF file and I/O methods */</font>
00064         gt-&gt;gt_tif = (tiff_t *)tif;
00065         _GTIFSetDefaultTIFF(&amp;gt-&gt;gt_methods);
00066         
00067         <font class="comment">/* since this is an array, GTIF will allocate the memory */</font>
00068         <font class="keywordflow">if</font> (!(gt-&gt;gt_methods.get)(tif, GTIFF_GEOKEYDIRECTORY, &amp;gt-&gt;gt_nshorts, &amp;data ))
00069         {
00070                 <font class="comment">/* No ProjectionInfo, create a blank one */</font>
00071                 data=(pinfo_t*)_GTIFcalloc((4+MAX_VALUES)*<font class="keyword">sizeof</font>(pinfo_t));
00072                 <font class="keywordflow">if</font> (!data) <font class="keywordflow">goto</font> failure;        
00073                 header = (KeyHeader *)data;
00074                 header-&gt;hdr_version = GvCurrentVersion;
00075                 header-&gt;hdr_rev_major = GvCurrentRevision;
00076                 header-&gt;hdr_rev_minor = GvCurrentMinorRev;
00077                 gt-&gt;gt_nshorts=<font class="keyword">sizeof</font>(KeyHeader)/<font class="keyword">sizeof</font>(pinfo_t);
00078         }
00079         gt-&gt;gt_short = data;
00080         header = (KeyHeader *)data;
00081         
00082         <font class="keywordflow">if</font> (header-&gt;hdr_version &gt; GvCurrentVersion) <font class="keywordflow">goto</font> failure;
00083         <font class="keywordflow">if</font> (header-&gt;hdr_rev_major &gt; GvCurrentRevision)
00084         {
00085                 <font class="comment">/* issue warning */</font>
00086         }
00087         
00088         <font class="comment">/* If we got here, then the geokey can be parsed */</font>
00089         count = header-&gt;hdr_num_keys;
00090         gt-&gt;gt_num_keys = count;
00091         gt-&gt;gt_version  = header-&gt;hdr_version;
00092         gt-&gt;gt_rev_major  = header-&gt;hdr_rev_major;
00093         gt-&gt;gt_rev_minor  = header-&gt;hdr_rev_minor;
00094 
00095         bufcount = count+MAX_KEYS; <font class="comment">/* allow for expansion */</font>
00096 
00097         <font class="comment">/* Get the PARAMS Tags, if any */</font>
00098         <font class="keywordflow">if</font> (!(gt-&gt;gt_methods.get)(tif, GTIFF_DOUBLEPARAMS, &amp;gt-&gt;gt_ndoubles, &amp;gt-&gt;gt_double ))
00099         {
00100                 gt-&gt;gt_double=(<font class="keywordtype">double</font>*)_GTIFcalloc(MAX_VALUES*<font class="keyword">sizeof</font>(<font class="keywordtype">double</font>));
00101                 <font class="keywordflow">if</font> (!gt-&gt;gt_double) <font class="keywordflow">goto</font> failure;       
00102         }
00103         <font class="keywordflow">if</font> (!(gt-&gt;gt_methods.get)(tif, GTIFF_ASCIIPARAMS, &amp;gt-&gt;gt_nascii, &amp;gt-&gt;gt_ascii ))
00104         {
00105                 gt-&gt;gt_ascii = (<font class="keywordtype">char</font>*)_GTIFcalloc(MAX_VALUES*<font class="keyword">sizeof</font>(<font class="keywordtype">char</font>));
00106                 <font class="keywordflow">if</font> (!gt-&gt;gt_ascii) <font class="keywordflow">goto</font> failure;
00107         }
00108         <font class="keywordflow">else</font>  gt-&gt;gt_nascii--; <font class="comment">/* last NULL doesn't count; "|" used for delimiter */</font>
00109 
00110         <font class="comment">/* allocate space for GeoKey array and its index */</font>
00111         gt-&gt;gt_keys = (GeoKey *)_GTIFcalloc( <font class="keyword">sizeof</font>(GeoKey)*bufcount);
00112         <font class="keywordflow">if</font> (!gt-&gt;gt_keys) <font class="keywordflow">goto</font> failure;
00113         gt-&gt;gt_keyindex = (<font class="keywordtype">int</font> *)_GTIFcalloc( <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>)*(MAX_KEYINDEX+1));
00114         <font class="keywordflow">if</font> (!gt-&gt;gt_keyindex) <font class="keywordflow">goto</font> failure;
00115         
00116         <font class="comment">/*  Loop to get all GeoKeys */</font>
00117         entptr = ((KeyEntry *)data) + 1;
00118         keyptr = gt-&gt;gt_keys;
00119         gt-&gt;gt_keymin = MAX_KEYINDEX;
00120         gt-&gt;gt_keymax = 0;
00121         <font class="keywordflow">for</font> (index=1; index&lt;=count; index++,entptr++)
00122         {
00123                 <font class="keywordflow">if</font> (!ReadKey(gt, entptr, ++keyptr))
00124                         <font class="keywordflow">goto</font> failure;
00125                         
00126                 <font class="comment">/* Set up the index (start at 1, since 0=unset) */</font>
00127                 gt-&gt;gt_keyindex[entptr-&gt;ent_key] = index;               
00128         }
00129         
00130         <font class="keywordflow">return</font> gt;
00131         
00132 failure:
00133         <font class="comment">/* Notify of error */</font>
00134         <font class="keywordflow">if</font> (gt) free(gt);
00135         <font class="keywordflow">return</font> (GTIF *)0;
00136 }
00137 
00138 <font class="comment">/**********************************************************************</font>
00139 <font class="comment"> *</font>
00140 <font class="comment"> *                        Private Routines</font>
00141 <font class="comment"> *</font>
00142 <font class="comment"> **********************************************************************/</font>
00143 
00144 <font class="comment">/*</font>
00145 <font class="comment"> * Given KeyEntry, read in the GeoKey value location and set up</font>
00146 <font class="comment"> *  the Key structure, returning 0 if failure.</font>
00147 <font class="comment"> */</font>
00148 
00149 <font class="keyword">static</font> <font class="keywordtype">int</font> ReadKey(GTIF* gt, KeyEntry* entptr,GeoKey* keyptr)<font class="keyword"></font>
00150 <font class="keyword"></font>{
00151         <font class="keywordtype">int</font> offset,count;
00152         
00153         keyptr-&gt;gk_key = entptr-&gt;ent_key;
00154         keyptr-&gt;gk_count = entptr-&gt;ent_count;
00155         count = entptr-&gt;ent_count;
00156         offset = entptr-&gt;ent_val_offset;
00157         <font class="keywordflow">if</font> (gt-&gt;gt_keymin &gt; keyptr-&gt;gk_key)  gt-&gt;gt_keymin=keyptr-&gt;gk_key;
00158         <font class="keywordflow">if</font> (gt-&gt;gt_keymax &lt; keyptr-&gt;gk_key)  gt-&gt;gt_keymax=keyptr-&gt;gk_key;
00159         
00160         <font class="keywordflow">if</font> (entptr-&gt;ent_location)
00161           keyptr-&gt;gk_type = (gt-&gt;gt_methods.type)(gt-&gt;gt_tif,entptr-&gt;ent_location);
00162         <font class="keywordflow">else</font>
00163           keyptr-&gt;gk_type = (gt-&gt;gt_methods.type)(gt-&gt;gt_tif,GTIFF_GEOKEYDIRECTORY);
00164           
00165         <font class="keywordflow">switch</font> (entptr-&gt;ent_location)
00166         {
00167                 <font class="keywordflow">case</font> GTIFF_LOCAL:
00168                         <font class="comment">/* store value into data value */</font>
00169                         *(pinfo_t *)(&amp;keyptr-&gt;gk_data) = entptr-&gt;ent_val_offset;
00170                         <font class="keywordflow">break</font>;
00171                 <font class="keywordflow">case</font> GTIFF_GEOKEYDIRECTORY:
00172                         keyptr-&gt;gk_data = (<font class="keywordtype">char</font> *)(gt-&gt;gt_short+offset);
00173                         <font class="keywordflow">if</font> (gt-&gt;gt_nshorts &lt; offset+count)
00174                                 gt-&gt;gt_nshorts = offset+count;
00175                         <font class="keywordflow">break</font>;
00176                 <font class="keywordflow">case</font> GTIFF_DOUBLEPARAMS:
00177                         keyptr-&gt;gk_data = (<font class="keywordtype">char</font> *)(gt-&gt;gt_double+offset);
00178                         <font class="keywordflow">if</font> (gt-&gt;gt_ndoubles &lt; offset+count)
00179                                 gt-&gt;gt_ndoubles = offset+count;
00180                         <font class="keywordflow">break</font>;
00181                 <font class="keywordflow">case</font> GTIFF_ASCIIPARAMS:
00182                         keyptr-&gt;gk_data = (<font class="keywordtype">char</font> *)(gt-&gt;gt_ascii+offset);
00183                         <font class="keywordflow">if</font> (gt-&gt;gt_nascii &lt; offset+count)
00184                                 gt-&gt;gt_nascii = offset+count;
00185                         <font class="keywordflow">break</font>;
00186                 <font class="keywordflow">default</font>:
00187                         <font class="keywordflow">return</font> 0; <font class="comment">/* failure */</font>
00188         }
00189         keyptr-&gt;gk_size = _gtiff_size[keyptr-&gt;gk_type];
00190         
00191         <font class="keywordflow">return</font> 1; <font class="comment">/* success */</font>
00192 }
</div></pre><hr><address><small>Generated at Sun Mar 4 23:32:44 2001 for libgeotiff by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3-20001105 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
