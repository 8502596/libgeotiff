<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>geo_set.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3-20001105 on Sun Mar 4 22:25:49 2001 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>geo_set.c</h1><div class="fragment"><pre>00001 <font class="comment">/**********************************************************************</font>
00002 <font class="comment"> *</font>
00003 <font class="comment"> *  geo_set.c  -- Public routines for GEOTIFF GeoKey access.</font>
00004 <font class="comment"> *</font>
00005 <font class="comment"> *    Written By: Niles D. Ritter.</font>
00006 <font class="comment"> *</font>
00007 <font class="comment"> *  copyright (c) 1995   Niles D. Ritter</font>
00008 <font class="comment"> *</font>
00009 <font class="comment"> *  Permission granted to use this software, so long as this copyright</font>
00010 <font class="comment"> *  notice accompanies any products derived therefrom.</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> * $Log$
00012 <font class="comment"> * Revision 1.1  2001/03/05 03:34:00  warmerda
00012 <font class="comment"> * New
00012 <font class="comment"> *</font>
00013 <font class="comment"> * Revision 1.5  1999/05/04 03:09:33  warmerda</font>
00014 <font class="comment"> * avoid warnings</font>
00015 <font class="comment"> *</font>
00016 <font class="comment"> * Revision 1.4  1999/05/03 17:50:31  warmerda</font>
00017 <font class="comment"> * avoid warnings on IRIX</font>
00018 <font class="comment"> *</font>
00019 <font class="comment"> * Revision 1.3  1999/04/28 19:59:38  warmerda</font>
00020 <font class="comment"> * added some doxygen style documentation</font>
00021 <font class="comment"> *</font>
00022 <font class="comment"> * Revision 1.2  1999/03/11 17:39:38  geotiff</font>
00023 <font class="comment"> * Added fix for case where a key is being overwritten.</font>
00024 <font class="comment"> *</font>
00025 <font class="comment"> **********************************************************************/</font>
00026 
00027 <font class="preprocessor">#include "<a class="code" href="geotiff_h.html">geotiff.h</a>"</font>   <font class="comment">/* public interface        */</font>
00028 <font class="preprocessor">#include "geo_tiffp.h"</font> <font class="comment">/* external TIFF interface */</font>
00029 <font class="preprocessor">#include "geo_keyp.h"</font>  <font class="comment">/* private interface       */</font>
00030 
00031 <font class="preprocessor">#include &lt;assert.h&gt;</font>
00032 
00091 <font class="keywordtype">int</font> <a class="code" href="geotiff_h.html#a24">GTIFKeySet</a>(GTIF *gtif, geokey_t keyID, tagtype_t type, <font class="keywordtype">int</font> count,...)<font class="keyword"></font>
00092 <font class="keyword"></font>{
00093         va_list ap;
00094         <font class="keywordtype">int</font> index = gtif-&gt;gt_keyindex[ keyID ];
00095         <font class="keywordtype">int</font> newvalues = 0;
00096         GeoKey *key;
00097         <font class="keywordtype">char</font> *data;
00098         <font class="keywordtype">char</font> *val;
00099         pinfo_t sval;
00100         <font class="keywordtype">double</font> dval;
00101 
00102         va_start(ap, count);
00103         <font class="comment">/* pass singleton keys by value */</font>
00104         <font class="keywordflow">if</font> (count&gt;1 &amp;&amp; type!=TYPE_ASCII) val = va_arg(ap, <font class="keywordtype">char</font>*);
00105         <font class="keywordflow">else</font> <font class="keywordflow">switch</font> (type)
00106         {
00107             <font class="keywordflow">case</font> TYPE_SHORT:  sval=va_arg(ap, <font class="keywordtype">int</font>); val=(<font class="keywordtype">char</font> *)&amp;sval;     <font class="keywordflow">break</font>;
00108             <font class="keywordflow">case</font> TYPE_DOUBLE: dval=va_arg(ap, dblparam_t); val=(<font class="keywordtype">char</font> *)&amp;dval;  <font class="keywordflow">break</font>;
00109             <font class="keywordflow">case</font> TYPE_ASCII: 
00110                         val=va_arg(ap, <font class="keywordtype">char</font>*);
00111                         count = strlen(val) + 1; <font class="comment">/* force = string length */</font>
00112                         <font class="keywordflow">break</font>;
00113           <font class="keywordflow">default</font>:
00114             assert( FALSE );
00115             <font class="keywordflow">break</font>;
00116         }
00117         va_end(ap);
00118         
00119         <font class="comment">/* We assume here that there are no multi-valued SHORTS ! */</font>
00120         <font class="keywordflow">if</font> (index)
00121         {
00122                 <font class="comment">/* Key already exists */</font>
00123                 key = gtif-&gt;gt_keys+index;
00124                 <font class="keywordflow">if</font> (type!=key-&gt;gk_type || count &gt; key-&gt;gk_count)
00125                 {
00126                         <font class="comment">/* need to reset data pointer */</font>
00127                         key-&gt;gk_type = type;
00128                         key-&gt;gk_count = count;
00129                         key-&gt;gk_size = _gtiff_size[ type ];
00130                         newvalues = 1;
00131                 }
00132         }
00133         <font class="keywordflow">else</font>
00134         {
00135                 <font class="comment">/* We need to create the key */</font>
00136                 <font class="keywordflow">if</font> (gtif-&gt;gt_num_keys == MAX_KEYS) <font class="keywordflow">return</font> 0;
00137                 key = gtif-&gt;gt_keys + ++gtif-&gt;gt_num_keys;
00138                 index = gtif-&gt;gt_num_keys;
00139                 gtif-&gt;gt_keyindex[ keyID ] = index;
00140                 key-&gt;gk_key = keyID;
00141                 key-&gt;gk_type = type;
00142                 key-&gt;gk_count = count;
00143                 key-&gt;gk_size = _gtiff_size[ type ];
00144                 <font class="keywordflow">if</font> (gtif-&gt;gt_keymin &gt; keyID)  gtif-&gt;gt_keymin=keyID;
00145                 <font class="keywordflow">if</font> (gtif-&gt;gt_keymax &lt; keyID)  gtif-&gt;gt_keymax=keyID;
00146                 newvalues = 1;
00147         }
00148 
00149         <font class="keywordflow">if</font> (newvalues)
00150         {
00151            <font class="keywordflow">switch</font> (type)
00152            {
00153             <font class="keywordflow">case</font> TYPE_SHORT:  
00154                         <font class="keywordflow">if</font> (count &gt; 1) <font class="keywordflow">return</font> 0;
00155                         data = (<font class="keywordtype">char</font> *)&amp;key-&gt;gk_data; <font class="comment">/* store value *in* data */</font>
00156                         <font class="keywordflow">break</font>;
00157             <font class="keywordflow">case</font> TYPE_DOUBLE:
00158                         key-&gt;gk_data = (<font class="keywordtype">char</font> *)(gtif-&gt;gt_double + gtif-&gt;gt_ndoubles);
00159                         data = key-&gt;gk_data;
00160                         gtif-&gt;gt_ndoubles += count;
00161                         <font class="keywordflow">break</font>;
00162             <font class="keywordflow">case</font> TYPE_ASCII:
00163                         key-&gt;gk_data = (<font class="keywordtype">char</font> *)(gtif-&gt;gt_ascii + gtif-&gt;gt_nascii);
00164                         data = key-&gt;gk_data;
00165                         gtif-&gt;gt_nascii += count;
00166                         data[--count] = <font class="charliteral">'|'</font>; <font class="comment">/* replace NULL with '|' */</font>
00167                         <font class="keywordflow">break</font>;
00168             <font class="keywordflow">default</font>:
00169                         va_end(ap);
00170                 <font class="keywordflow">return</font> 0;
00171           }
00172            gtif-&gt;gt_nshorts += <font class="keyword">sizeof</font>(KeyEntry)/<font class="keyword">sizeof</font>(pinfo_t);
00173         }
00174 
00175         <font class="comment">/* this fixes a bug where if a request is made to write a duplicate</font>
00176 <font class="comment">           key, we must initialize the data to a valid value.</font>
00177 <font class="comment">           Bryan Wells (bryan@athena.bangor.autometric.com) */</font>
00178         
00179         <font class="keywordflow">else</font> <font class="comment">/* no new values, but still have something to write */</font>
00180         {
00181            <font class="keywordflow">switch</font> (type)
00182            {
00183             <font class="keywordflow">case</font> TYPE_SHORT:  
00184                         <font class="keywordflow">if</font> (count &gt; 1) <font class="keywordflow">return</font> 0;
00185                         data = (<font class="keywordtype">char</font> *)&amp;key-&gt;gk_data; <font class="comment">/* store value *in* data */</font>
00186                         <font class="keywordflow">break</font>;
00187             <font class="keywordflow">case</font> TYPE_DOUBLE:
00188                         data = key-&gt;gk_data;
00189                         <font class="keywordflow">break</font>;
00190             <font class="keywordflow">case</font> TYPE_ASCII:
00191                         data = key-&gt;gk_data;
00192                         data[--count] = <font class="charliteral">'|'</font>; <font class="comment">/* replace NULL with '|' */</font>
00193                         <font class="keywordflow">break</font>;
00194             <font class="keywordflow">default</font>:
00195                 <font class="keywordflow">return</font> 0;
00196           }
00197 
00198         }
00199         
00200         _GTIFmemcpy(data, val, count*key-&gt;gk_size);
00201         
00202         gtif-&gt;gt_flags |= FLAG_FILE_MODIFIED;
00203         <font class="keywordflow">return</font> 1;
00204 }
</div></pre><hr><address><small>Generated at Sun Mar 4 22:25:49 2001 for libgeotiff by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3-20001105 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
