<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>geo_tiffp.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3-20001105 on Sun Mar 4 22:25:49 2001 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>geo_tiffp.c</h1><div class="fragment"><pre>00001 <font class="comment">/**********************************************************************</font>
00002 <font class="comment"> *</font>
00003 <font class="comment"> *  geo_tiffp.c  Private TIFF interface module for GEOTIFF</font>
00004 <font class="comment"> *</font>
00005 <font class="comment"> *    This module implements the interface between the GEOTIFF</font>
00006 <font class="comment"> *    tag parser and the TIFF i/o module. The current setup</font>
00007 <font class="comment"> *    relies on the "libtiff" code, but if you use your own</font>
00008 <font class="comment"> *    TIFF reader software, you may replace the module implementations</font>
00009 <font class="comment"> *    here with your own calls. No "libtiff" dependencies occur</font>
00010 <font class="comment"> *    anywhere else in this code.</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> **********************************************************************/</font>
00013  
00014 <font class="preprocessor">#include "<a class="code" href="geotiff_h.html">geotiff.h</a>"</font>    <font class="comment">/* public GTIFF interface */</font>
00015 
00016 <font class="preprocessor">#include "geo_tiffp.h"</font>  <font class="comment">/* Private TIFF interface */</font>
00017 <font class="preprocessor">#include "geo_keyp.h"</font>   <font class="comment">/* Private GTIFF interface */</font>
00018 
00019 <font class="comment">/* tiff size array global */</font>
00020 gsize_t _gtiff_size[] = { 0, 1, 2, 4, 8, 1, 4, 8, 1, 2, 4, 1 };
00021 
00022 <font class="keyword">static</font> <font class="keywordtype">int</font>        _GTIFGetField (tiff_t *tif, pinfo_t tag, <font class="keywordtype">int</font> *count, <font class="keywordtype">void</font> *value );
00023 <font class="keyword">static</font> <font class="keywordtype">int</font>        _GTIFSetField (tiff_t *tif, pinfo_t tag, <font class="keywordtype">int</font>  count, <font class="keywordtype">void</font> *value );
00024 <font class="keyword">static</font> tagtype_t  _GTIFTagType  (tiff_t *tif, pinfo_t tag);
00025 
00026 <font class="comment">/*</font>
00027 <font class="comment"> * Set up default TIFF handlers. </font>
00028 <font class="comment"> */</font>
00029 <font class="keywordtype">void</font> _GTIFSetDefaultTIFF(TIFFMethod *method)<font class="keyword"></font>
00030 <font class="keyword"></font>{
00031         <font class="keywordflow">if</font> (!method) <font class="keywordflow">return</font>;
00032         
00033         method-&gt;get = _GTIFGetField;
00034         method-&gt;set = _GTIFSetField;
00035         method-&gt;type = _GTIFTagType;
00036 }
00037 
00038 gdata_t _GTIFcalloc(gsize_t size)<font class="keyword"></font>
00039 <font class="keyword"></font>{
00040     gdata_t data=(gdata_t)_TIFFmalloc((tsize_t)size);
00041         <font class="keywordflow">if</font> (data) _TIFFmemset((tdata_t)data,0,(tsize_t)size);
00042         <font class="keywordflow">return</font> data;
00043 }
00044 
00045 gdata_t _GTIFrealloc(gdata_t ptr, gsize_t size)<font class="keyword"></font>
00046 <font class="keyword"></font>{
00047     <font class="keywordflow">return</font>( _TIFFrealloc((tdata_t)ptr, (tsize_t) size) );
00048 }
00049 
00050 <font class="keywordtype">void</font> _GTIFmemcpy(gdata_t out,gdata_t in,gsize_t size)<font class="keyword"></font>
00051 <font class="keyword"></font>{
00052         _TIFFmemcpy((tdata_t)out,(tdata_t)in,(tsize_t)size);
00053 }
00054 
00055 <font class="keywordtype">void</font> _GTIFFree(gdata_t data)<font class="keyword"></font>
00056 <font class="keyword"></font>{
00057         <font class="keywordflow">if</font> (data) _TIFFfree((tdata_t)data);
00058 }
00059 
00060 
00061 
00062 <font class="comment">/* returns the value of TIFF tag &lt;tag&gt;, or if</font>
00063 <font class="comment"> * the value is an array, returns an allocated buffer</font>
00064 <font class="comment"> * containing the values. Allocate a copy of the actual</font>
00065 <font class="comment"> * buffer, sized up for updating.</font>
00066 <font class="comment"> */</font>
00067 <font class="keyword">static</font> <font class="keywordtype">int</font> _GTIFGetField (tiff_t *tif, pinfo_t tag, <font class="keywordtype">int</font> *count, <font class="keywordtype">void</font> *val )<font class="keyword"></font>
00068 <font class="keyword"></font>{
00069         <font class="keywordtype">int</font> status;
00070         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> scount=0;
00071         <font class="keywordtype">char</font> *tmp;
00072         <font class="keywordtype">char</font> *value;
00073         gsize_t size = _gtiff_size[_GTIFTagType (tif,tag)];
00074         
00075         <font class="keywordflow">if</font> (_GTIFTagType(tif,  tag) == TYPE_ASCII)
00076         {
00077                 status = TIFFGetField((TIFF *)tif,tag,&amp;tmp);
00078                 <font class="keywordflow">if</font> (!status) <font class="keywordflow">return</font> status;
00079                 scount = strlen(tmp)+1;
00080         }
00081         <font class="keywordflow">else</font> status = TIFFGetField((TIFF *)tif,tag,&amp;scount,&amp;tmp);
00082         <font class="keywordflow">if</font> (!status) <font class="keywordflow">return</font> status;
00083         
00084         *count = scount;
00085 
00086         value = (<font class="keywordtype">char</font> *)_GTIFcalloc( (scount+MAX_VALUES)*size);
00087         <font class="keywordflow">if</font> (!value) <font class="keywordflow">return</font> 0;
00088         
00089         _TIFFmemcpy( value, tmp,  size * scount);
00090         
00091         *(<font class="keywordtype">char</font> **)val = value;
00092         <font class="keywordflow">return</font> status;
00093 }
00094 
00095 <font class="comment">/* </font>
00096 <font class="comment"> * Set a GeoTIFF TIFF field.</font>
00097 <font class="comment"> */</font>
00098 <font class="keyword">static</font> <font class="keywordtype">int</font> _GTIFSetField (tiff_t *tif, pinfo_t tag, <font class="keywordtype">int</font> count, <font class="keywordtype">void</font> *value )<font class="keyword"></font>
00099 <font class="keyword"></font>{
00100         <font class="keywordtype">int</font> status;
00101         <font class="keywordtype">unsigned</font> <font class="keywordtype">short</font> scount = count;
00102 
00103         <font class="comment">/* libtiff ASCII uses null-delimiter */</font>
00104         <font class="keywordflow">if</font> (_GTIFTagType(tif,  tag) == TYPE_ASCII)
00105                 status = TIFFSetField((TIFF *)tif,tag,value);
00106         <font class="keywordflow">else</font> 
00107                 status = TIFFSetField((TIFF *)tif,tag,scount,value);
00108         <font class="keywordflow">return</font> status;
00109 }
00110 
00111 
00112 <font class="comment">/*</font>
00113 <font class="comment"> *  This routine is supposed to return the TagType of the &lt;tag&gt;</font>
00114 <font class="comment"> *  TIFF tag. Unfortunately, "libtiff" does not provide this</font>
00115 <font class="comment"> *  service by default, so we just have to "know" what type of tags</font>
00116 <font class="comment"> *  we've got, and how many. We only define the ones Geotiff</font>
00117 <font class="comment"> *  uses here, and others return UNKNOWN. The "tif" parameter</font>
00118 <font class="comment"> *  is provided for those TIFF implementations that provide</font>
00119 <font class="comment"> *  for tag-type queries.</font>
00120 <font class="comment"> */</font>
00121 <font class="keyword">static</font> tagtype_t  _GTIFTagType  (tiff_t *tif, pinfo_t tag)<font class="keyword"></font>
00122 <font class="keyword"></font>{
00123         tagtype_t ttype;
00124 
00125         (<font class="keywordtype">void</font>) tif; <font class="comment">/* dummy reference */</font>
00126         
00127         <font class="keywordflow">switch</font> (tag)
00128         {
00129                 <font class="keywordflow">case</font> GTIFF_ASCIIPARAMS:    ttype=TYPE_ASCII; <font class="keywordflow">break</font>;
00130                 <font class="keywordflow">case</font> GTIFF_PIXELSCALE:
00131                 <font class="keywordflow">case</font> GTIFF_TRANSMATRIX:
00132                 <font class="keywordflow">case</font> GTIFF_TIEPOINTS:
00133                 <font class="keywordflow">case</font> GTIFF_DOUBLEPARAMS:   ttype=TYPE_DOUBLE; <font class="keywordflow">break</font>;
00134                 <font class="keywordflow">case</font> GTIFF_GEOKEYDIRECTORY: ttype=TYPE_SHORT; <font class="keywordflow">break</font>;
00135                 <font class="keywordflow">default</font>: ttype = TYPE_UNKNOWN;
00136         }
00137         
00138         <font class="keywordflow">return</font> ttype;
00139 }
00140 
</div></pre><hr><address><small>Generated at Sun Mar 4 22:25:49 2001 for libgeotiff by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3-20001105 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
