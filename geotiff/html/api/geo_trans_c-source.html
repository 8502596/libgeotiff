<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>geo_trans.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3-20001105 on Sun Mar 4 23:32:44 2001 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>geo_trans.c</h1><div class="fragment"><pre>00001 <font class="comment">/******************************************************************************</font>
00002 <font class="comment"> * $Id$</font>
00003 <font class="comment"> *</font>
00004 <font class="comment"> * Project:  libgeotiff</font>
00005 <font class="comment"> * Purpose:  Code to abstract translation between pixel/line and PCS</font>
00006 <font class="comment"> *           coordinates.</font>
00007 <font class="comment"> * Author:   Frank Warmerdam, warmerda@home.com</font>
00008 <font class="comment"> *</font>
00009 <font class="comment"> ******************************************************************************</font>
00010 <font class="comment"> * Copyright (c) 1999, Frank Warmerdam</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> * Permission is hereby granted, free of charge, to any person obtaining a</font>
00013 <font class="comment"> * copy of this software and associated documentation files (the "Software"),</font>
00014 <font class="comment"> * to deal in the Software without restriction, including without limitation</font>
00015 <font class="comment"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</font>
00016 <font class="comment"> * and/or sell copies of the Software, and to permit persons to whom the</font>
00017 <font class="comment"> * Software is furnished to do so, subject to the following conditions:</font>
00018 <font class="comment"> *</font>
00019 <font class="comment"> * The above copyright notice and this permission notice shall be included</font>
00020 <font class="comment"> * in all copies or substantial portions of the Software.</font>
00021 <font class="comment"> *</font>
00022 <font class="comment"> * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS</font>
00023 <font class="comment"> * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</font>
00024 <font class="comment"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL</font>
00025 <font class="comment"> * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</font>
00026 <font class="comment"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</font>
00027 <font class="comment"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</font>
00028 <font class="comment"> * DEALINGS IN THE SOFTWARE.</font>
00029 <font class="comment"> ******************************************************************************</font>
00030 <font class="comment"> *</font>
00031 <font class="comment"> * $Log$
00031 <font class="comment"> * Revision 1.2  2001/03/05 04:58:33  warmerda
00031 <font class="comment"> * updated
00031 <font class="comment"> *</font>
00032 <font class="comment"> * Revision 1.7  2001/03/05 03:25:23  warmerda</font>
00033 <font class="comment"> * restructure cleanup, and apply to GTIFPCSToImage()</font>
00034 <font class="comment"> *</font>
00035 <font class="comment"> * Revision 1.6  2001/03/04 22:37:39  warmerda</font>
00036 <font class="comment"> * fixed memory leak for fields fetched with gt_methods.get - Alan Gray</font>
00037 <font class="comment"> *</font>
00038 <font class="comment"> * Revision 1.5  2000/08/22 03:32:46  warmerda</font>
00039 <font class="comment"> * removed GTIFTiepointTranslate code</font>
00040 <font class="comment"> *</font>
00041 <font class="comment"> * Revision 1.4  1999/09/17 01:19:51  warmerda</font>
00042 <font class="comment"> * Fixed bug in use of transform matrix.</font>
00043 <font class="comment"> *</font>
00044 <font class="comment"> * Revision 1.3  1999/09/16 21:25:40  warmerda</font>
00045 <font class="comment"> * Added tiepoint, and transformation matrix based translation.  Note</font>
00046 <font class="comment"> * that we don't try to invert the transformation matrix for</font>
00047 <font class="comment"> * GTIFPCSToImage().</font>
00048 <font class="comment"> *</font>
00049 <font class="comment"> * Revision 1.2  1999/09/07 20:00:40  warmerda</font>
00050 <font class="comment"> * Fixed count/tiepoint_count bug in GTIFPCSToImage().</font>
00051 <font class="comment"> *</font>
00052 <font class="comment"> * Revision 1.1  1999/05/04 03:07:57  warmerda</font>
00053 <font class="comment"> * New</font>
00054 <font class="comment"> *</font>
00055 <font class="comment"> */</font>
00056  
00057 <font class="preprocessor">#include "<a class="code" href="geotiff_h.html">geotiff.h</a>"</font>
00058 <font class="preprocessor">#include "geo_tiffp.h"</font> <font class="comment">/* external TIFF interface */</font>
00059 <font class="preprocessor">#include "geo_keyp.h"</font>  <font class="comment">/* private interface       */</font>
00060 <font class="preprocessor">#include "geokeys.h"</font>
00061 
00062 <font class="comment">/************************************************************************/</font>
00063 <font class="comment">/*                       GTIFTiepointTranslate()                        */</font>
00064 <font class="comment">/************************************************************************/</font>
00065 
00066 <font class="keywordtype">int</font> GTIFTiepointTranslate( <font class="keywordtype">int</font> gcp_count, <font class="keywordtype">double</font> * gcps_in, <font class="keywordtype">double</font> * gcps_out,
00067                            <font class="keywordtype">double</font> x_in, <font class="keywordtype">double</font> y_in,
00068                            <font class="keywordtype">double</font> *x_out, <font class="keywordtype">double</font> *y_out )<font class="keyword"></font>
00069 <font class="keyword"></font>
00070 <font class="keyword"></font>{
00071     <font class="comment">/* I would appreciate a _brief_ block of code for doing second order</font>
00072 <font class="comment">       polynomial regression here! */</font>
00073     <font class="keywordflow">return</font> FALSE;
00074 }
00075 
00076 
00077 <font class="comment">/************************************************************************/</font>
00078 <font class="comment">/*                           GTIFImageToPCS()                           */</font>
00079 <font class="comment">/************************************************************************/</font>
00080 
00099 <font class="keywordtype">int</font> <a class="code" href="geotiff_h.html#a35">GTIFImageToPCS</a>( GTIF *gtif, <font class="keywordtype">double</font> *x, <font class="keywordtype">double</font> *y )<font class="keyword"></font>
00100 <font class="keyword"></font>
00101 <font class="keyword"></font>{
00102     <font class="keywordtype">int</font>     res = FALSE;
00103     <font class="keywordtype">int</font>     tiepoint_count, count, transform_count;
00104     tiff_t *tif=gtif-&gt;gt_tif;
00105     <font class="keywordtype">double</font> *tiepoints   = 0;
00106     <font class="keywordtype">double</font> *pixel_scale = 0;
00107     <font class="keywordtype">double</font> *transform   = 0;
00108 
00109 
00110     <font class="keywordflow">if</font> (!(gtif-&gt;gt_methods.get)(tif, GTIFF_TIEPOINTS,
00111                               &amp;tiepoint_count, &amp;tiepoints ))
00112         tiepoint_count = 0;
00113 
00114     <font class="keywordflow">if</font> (!(gtif-&gt;gt_methods.get)(tif, GTIFF_PIXELSCALE, &amp;count, &amp;pixel_scale ))
00115         count = 0;
00116 
00117     <font class="keywordflow">if</font> (!(gtif-&gt;gt_methods.get)(tif, GTIFF_TRANSMATRIX,
00118                                 &amp;transform_count, &amp;transform ))
00119         transform_count = 0;
00120 
00121 <font class="comment">/* -------------------------------------------------------------------- */</font>
00122 <font class="comment">/*      If the pixelscale count is zero, but we have tiepoints use      */</font>
00123 <font class="comment">/*      the tiepoint based approach.                                    */</font>
00124 <font class="comment">/* -------------------------------------------------------------------- */</font>
00125     <font class="keywordflow">if</font>( tiepoint_count &gt; 6 &amp;&amp; count == 0 ) 
00126     {
00127         res = GTIFTiepointTranslate( tiepoint_count / 6,
00128                                      tiepoints, tiepoints + 3,
00129                                      *x, *y, x, y );
00130     }
00131 
00132 <font class="comment">/* -------------------------------------------------------------------- */</font>
00133 <font class="comment">/*      If we have a transformation matrix, use it.                     */</font>
00134 <font class="comment">/* -------------------------------------------------------------------- */</font>
00135     <font class="keywordflow">else</font> <font class="keywordflow">if</font>( transform_count == 16 ) 
00136     {
00137         <font class="keywordtype">double</font> x_in = *x, y_in = *y;
00138 
00139         *x = x_in * transform[0] + y_in * transform[1] + transform[3];
00140         *y = x_in * transform[4] + y_in * transform[5] + transform[7];
00141         
00142         res = TRUE;
00143     } 
00144 
00145 <font class="comment">/* -------------------------------------------------------------------- */</font>
00146 <font class="comment">/*      For now we require one tie point, and a valid pixel scale.      */</font>
00147 <font class="comment">/* -------------------------------------------------------------------- */</font>
00148     <font class="keywordflow">else</font> <font class="keywordflow">if</font>( count &lt; 3 || tiepoint_count &lt; 6 ) 
00149     {
00150         res = FALSE;
00151     } 
00152 
00153     <font class="keywordflow">else</font> 
00154     {
00155         *x = (*x - tiepoints[0]) * pixel_scale[0] + tiepoints[3];
00156         *y = (*y - tiepoints[1]) * (-1 * pixel_scale[1]) + tiepoints[4];
00157 
00158         res = TRUE;
00159     }
00160 
00161 <font class="comment">/* -------------------------------------------------------------------- */</font>
00162 <font class="comment">/*      Cleanup                                                         */</font>
00163 <font class="comment">/* -------------------------------------------------------------------- */</font>
00164     <font class="keywordflow">if</font>(tiepoints)   
00165         _GTIFFree(tiepoints);
00166     <font class="keywordflow">if</font>(pixel_scale)
00167         _GTIFFree(pixel_scale);
00168     <font class="keywordflow">if</font>(transform)  
00169         _GTIFFree(transform);
00170 
00171     <font class="keywordflow">return</font> res;
00172 }
00173 
00174 <font class="comment">/************************************************************************/</font>
00175 <font class="comment">/*                           GTIFPCSToImage()                           */</font>
00176 <font class="comment">/************************************************************************/</font>
00177 
00196 <font class="keywordtype">int</font> <a class="code" href="geotiff_h.html#a36">GTIFPCSToImage</a>( GTIF *gtif, <font class="keywordtype">double</font> *x, <font class="keywordtype">double</font> *y )<font class="keyword"></font>
00197 <font class="keyword"></font>
00198 <font class="keyword"></font>{
00199     <font class="keywordtype">double</font>      *tiepoints;
00200     <font class="keywordtype">int</font>         tiepoint_count, count;
00201     <font class="keywordtype">double</font>      *pixel_scale;
00202     tiff_t *tif=gtif-&gt;gt_tif;
00203     <font class="keywordtype">int</font>         result = FALSE;
00204 
00205 <font class="comment">/* -------------------------------------------------------------------- */</font>
00206 <font class="comment">/*      Fetch tiepoints and pixel scale.                                */</font>
00207 <font class="comment">/* -------------------------------------------------------------------- */</font>
00208     <font class="keywordflow">if</font> (!(gtif-&gt;gt_methods.get)(tif, GTIFF_TIEPOINTS,
00209                               &amp;tiepoint_count, &amp;tiepoints ))
00210         tiepoint_count = 0;
00211 
00212     <font class="keywordflow">if</font> (!(gtif-&gt;gt_methods.get)(tif, GTIFF_PIXELSCALE, &amp;count, &amp;pixel_scale ))
00213         count = 0;
00214 
00215 <font class="comment">/* -------------------------------------------------------------------- */</font>
00216 <font class="comment">/*      If the pixelscale count is zero, but we have tiepoints use      */</font>
00217 <font class="comment">/*      the tiepoint based approach.                                    */</font>
00218 <font class="comment">/* -------------------------------------------------------------------- */</font>
00219     <font class="keywordflow">if</font>( tiepoint_count &gt; 6 &amp;&amp; count == 0 )
00220     {
00221         result = GTIFTiepointTranslate( tiepoint_count / 6,
00222                                         tiepoints + 3, tiepoints,
00223                                         *x, *y, x, y );
00224     }
00225     
00226 <font class="comment">/* -------------------------------------------------------------------- */</font>
00227 <font class="comment">/*      For now we require one tie point, and a valid pixel scale.      */</font>
00228 <font class="comment">/* -------------------------------------------------------------------- */</font>
00229     <font class="keywordflow">else</font> <font class="keywordflow">if</font>( count &gt;= 3 &amp;&amp; tiepoint_count &gt;= 6 )
00230     {
00231         *x = (*x - tiepoints[3]) / pixel_scale[0] + tiepoints[0];
00232         *y = (*y - tiepoints[4]) / (-1 * pixel_scale[1]) + tiepoints[1];
00233 
00234         result = TRUE;
00235     }
00236 
00237 <font class="comment">/* -------------------------------------------------------------------- */</font>
00238 <font class="comment">/*      Cleanup.                                                        */</font>
00239 <font class="comment">/* -------------------------------------------------------------------- */</font>
00240     <font class="keywordflow">if</font>(tiepoints)   
00241         _GTIFFree(tiepoints);
00242     <font class="keywordflow">if</font>(pixel_scale)
00243         _GTIFFree(pixel_scale);
00244 
00245     <font class="keywordflow">return</font> result;
00246 }
00247 
</div></pre><hr><address><small>Generated at Sun Mar 4 23:32:44 2001 for libgeotiff by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3-20001105 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
