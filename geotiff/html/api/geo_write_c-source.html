<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>geo_write.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3-20001105 on Sun Mar 4 22:25:49 2001 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>geo_write.c</h1><div class="fragment"><pre>00001 <font class="comment">/**********************************************************************</font>
00002 <font class="comment"> *</font>
00003 <font class="comment"> *  geo_write.c  -- Public routines for GEOTIFF GeoKey access.</font>
00004 <font class="comment"> *</font>
00005 <font class="comment"> *    Written By: Niles D. Ritter.</font>
00006 <font class="comment"> *</font>
00007 <font class="comment"> *  copyright (c) 1995   Niles D. Ritter</font>
00008 <font class="comment"> *</font>
00009 <font class="comment"> *  Permission granted to use this software, so long as this copyright</font>
00010 <font class="comment"> *  notice accompanies any source code derived therefrom.</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> **********************************************************************/</font>
00013 
00014 <font class="preprocessor">#include "geotiffio.h"</font>   <font class="comment">/* public interface        */</font>
00015 <font class="preprocessor">#include "geo_tiffp.h"</font> <font class="comment">/* external TIFF interface */</font>
00016 <font class="preprocessor">#include "geo_keyp.h"</font>  <font class="comment">/* private interface       */</font>
00017 
00018 <font class="keyword">static</font> <font class="keywordtype">int</font> WriteKey(GTIF* gt, KeyEntry* entptr,GeoKey* keyptr);
00019 <font class="keyword">static</font> <font class="keywordtype">int</font> SortKeys(GTIF* gt,<font class="keywordtype">int</font> *sortkeys);
00020 
00032 <font class="keywordtype">int</font> <a class="code" href="geotiff_h.html#a20">GTIFWriteKeys</a>(GTIF *gt)<font class="keyword"></font>
00033 <font class="keyword"></font>{
00034         <font class="keywordtype">int</font> i;
00035         GeoKey *keyptr;
00036         KeyEntry *entptr;
00037         KeyHeader *header;
00038         <font class="keywordtype">int</font> sortkeys[MAX_KEYS];
00039         
00040         <font class="keywordflow">if</font> (!(gt-&gt;gt_flags &amp; FLAG_FILE_MODIFIED)) <font class="keywordflow">return</font> 1;
00041         
00042         <font class="comment">/*  Sort the Keys into numerical order */</font>
00043         <font class="keywordflow">if</font> (!SortKeys(gt,sortkeys))
00044         {
00045                 <font class="comment">/* XXX error: a key was not recognized */</font>
00046         }
00047         
00048         <font class="comment">/* Set up header of ProjectionInfo tag */</font>
00049         header = (KeyHeader *)gt-&gt;gt_short;
00050         header-&gt;hdr_num_keys = gt-&gt;gt_num_keys;
00051         header-&gt;hdr_version  = GvCurrentVersion;
00052         header-&gt;hdr_rev_major  = GvCurrentRevision;
00053         header-&gt;hdr_rev_minor  = GvCurrentMinorRev;
00054         
00055         <font class="comment">/* Set up the rest of SHORT array properly */</font>
00056         keyptr = gt-&gt;gt_keys;
00057         entptr = (KeyEntry*)(gt-&gt;gt_short + 4);
00058         <font class="keywordflow">for</font> (i=0; i&lt; gt-&gt;gt_num_keys; i++,entptr++)
00059         {
00060                 <font class="keywordflow">if</font> (!WriteKey(gt,entptr,keyptr+sortkeys[i])) <font class="keywordflow">return</font> 0;
00061         }       
00062         
00063         <font class="comment">/* Write out the Key Directory */</font>
00064         (gt-&gt;gt_methods.set)(gt-&gt;gt_tif, GTIFF_GEOKEYDIRECTORY, gt-&gt;gt_nshorts, gt-&gt;gt_short ); 
00065         
00066         <font class="comment">/* Write out the params directories */</font>
00067         <font class="keywordflow">if</font> (gt-&gt;gt_ndoubles)
00068           (gt-&gt;gt_methods.set)(gt-&gt;gt_tif, GTIFF_DOUBLEPARAMS, gt-&gt;gt_ndoubles, gt-&gt;gt_double );
00069         <font class="keywordflow">if</font> (gt-&gt;gt_nascii)
00070         {
00071           gt-&gt;gt_ascii[gt-&gt;gt_nascii] = <font class="charliteral">'\0'</font>; <font class="comment">/* just to be safe */</font>
00072           (gt-&gt;gt_methods.set)(gt-&gt;gt_tif, GTIFF_ASCIIPARAMS, 0, gt-&gt;gt_ascii );
00073         }
00074         
00075         gt-&gt;gt_flags &amp;= ~FLAG_FILE_MODIFIED;
00076         <font class="keywordflow">return</font> 1;
00077 }
00078 
00079 <font class="comment">/**********************************************************************</font>
00080 <font class="comment"> *</font>
00081 <font class="comment"> *                        Private Routines</font>
00082 <font class="comment"> *</font>
00083 <font class="comment"> **********************************************************************/</font>
00084  
00085 <font class="comment">/*</font>
00086 <font class="comment"> * Given GeoKey, write out the KeyEntry entries, returning 0 if failure.</font>
00087 <font class="comment"> *  This is the exact complement of ReadKey().</font>
00088 <font class="comment"> */</font>
00089 
00090 <font class="keyword">static</font> <font class="keywordtype">int</font> WriteKey(GTIF* gt, KeyEntry* entptr,GeoKey* keyptr)<font class="keyword"></font>
00091 <font class="keyword"></font>{
00092         <font class="keywordtype">int</font> count;
00093         
00094         entptr-&gt;ent_key = keyptr-&gt;gk_key;
00095         entptr-&gt;ent_count = keyptr-&gt;gk_count;
00096         count = entptr-&gt;ent_count;
00097         
00098         <font class="keywordflow">if</font> (count==1 &amp;&amp; keyptr-&gt;gk_type==TYPE_SHORT)
00099         {
00100                 entptr-&gt;ent_location = GTIFF_LOCAL;
00101                 entptr-&gt;ent_val_offset = *(pinfo_t*)&amp;keyptr-&gt;gk_data;
00102                 <font class="keywordflow">return</font> 1;
00103         }
00104                   
00105         <font class="keywordflow">switch</font> (keyptr-&gt;gk_type)
00106         {
00107                 <font class="keywordflow">case</font> TYPE_SHORT:
00108                         entptr-&gt;ent_location = GTIFF_GEOKEYDIRECTORY;
00109                         entptr-&gt;ent_val_offset = 
00110                            (pinfo_t*)keyptr-&gt;gk_data - gt-&gt;gt_short;
00111                         <font class="keywordflow">break</font>;
00112                 <font class="keywordflow">case</font> TYPE_DOUBLE:
00113                         entptr-&gt;ent_location = GTIFF_DOUBLEPARAMS;
00114                         entptr-&gt;ent_val_offset = 
00115                            (<font class="keywordtype">double</font>*)keyptr-&gt;gk_data - gt-&gt;gt_double;
00116                         <font class="keywordflow">break</font>;
00117                 <font class="keywordflow">case</font> TYPE_ASCII:
00118                         entptr-&gt;ent_location = GTIFF_ASCIIPARAMS;
00119                         entptr-&gt;ent_val_offset = 
00120                            (<font class="keywordtype">char</font>*)keyptr-&gt;gk_data - gt-&gt;gt_ascii;
00121                         <font class="keywordflow">break</font>;
00122                 <font class="keywordflow">default</font>:
00123                         <font class="keywordflow">return</font> 0; <font class="comment">/* failure */</font>
00124         }
00125         
00126         <font class="keywordflow">return</font> 1; <font class="comment">/* success */</font>
00127 }
00128 
00129 
00130 <font class="comment">/* </font>
00131 <font class="comment"> * Numerically sort the GeoKeys.</font>
00132 <font class="comment"> * We just do a linear search through</font>
00133 <font class="comment"> * the list and pull out the keys that were set.</font>
00134 <font class="comment"> */</font>
00135 
00136 <font class="keyword">static</font> <font class="keywordtype">int</font> SortKeys(GTIF* gt,<font class="keywordtype">int</font> *sortkeys)<font class="keyword"></font>
00137 <font class="keyword"></font>{
00138     <font class="keywordtype">int</font> loc;
00139     <font class="keywordtype">int</font> nkeys=0;
00140     geokey_t key,kmin,kmax;
00141     <font class="keywordtype">int</font> *index = gt-&gt;gt_keyindex;
00142         
00143     kmin = (geokey_t) gt-&gt;gt_keymin;
00144     kmax = (geokey_t) gt-&gt;gt_keymax;
00145     <font class="keywordflow">for</font> (key=kmin; key&lt;=kmax; key++)
00146     {
00147         <font class="keywordflow">if</font> ( (loc=index[key]) != 0 )
00148         {
00149             sortkeys[nkeys] = loc;
00150             nkeys++;
00151         }
00152     }
00153         
00154     <font class="keywordflow">return</font> nkeys==gt-&gt;gt_num_keys;
00155 }
00156 
</div></pre><hr><address><small>Generated at Sun Mar 4 22:25:49 2001 for libgeotiff by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3-20001105 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
