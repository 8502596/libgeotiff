<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>xtiff.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3-20001105 on Sun Mar 4 22:25:49 2001 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>xtiff.c</h1><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment"> * xtiff.c</font>
00003 <font class="comment"> *</font>
00004 <font class="comment"> * Extended TIFF Directory GEO Tag Support.</font>
00005 <font class="comment"> *</font>
00006 <font class="comment"> *  You may use this file as a template to add your own</font>
00007 <font class="comment"> *  extended tags to the library. Only the parts of the code</font>
00008 <font class="comment"> *  marked with "XXX" require modification.</font>
00009 <font class="comment"> *</font>
00010 <font class="comment"> *  Author: Niles D. Ritter</font>
00011 <font class="comment"> *</font>
00012 <font class="comment"> *  Revisions:</font>
00013 <font class="comment"> *    18 Sep 1995   -- Deprecated Integraph Matrix tag with new one.</font>
00014 <font class="comment"> *                     Backward compatible support provided.  --NDR.</font>
00015 <font class="comment"> */</font>
00016  
00017 <font class="preprocessor">#include "xtiffiop.h"</font>
00018 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00019 
00020 <font class="comment">/*  Tiff info structure.</font>
00021 <font class="comment"> *</font>
00022 <font class="comment"> *     Entry format:</font>
00023 <font class="comment"> *        { TAGNUMBER, ReadCount, WriteCount, DataType, FIELDNUM, </font>
00024 <font class="comment"> *          OkToChange, PassDirCountOnSet, AsciiName }</font>
00025 <font class="comment"> *</font>
00026 <font class="comment"> *     For ReadCount, WriteCount, -1 = unknown.</font>
00027 <font class="comment"> */</font>
00028 
00029 <font class="keyword">static</font> <font class="keyword">const</font> TIFFFieldInfo xtiffFieldInfo[] = {
00030   
00031   <font class="comment">/* XXX Insert Your tags here */</font>
00032     { TIFFTAG_GEOPIXELSCALE,    -1,-1, TIFF_DOUBLE,     FIELD_GEOPIXELSCALE,
00033       TRUE,     TRUE,   <font class="stringliteral">"GeoPixelScale"</font> },
00034     { TIFFTAG_INTERGRAPH_MATRIX,-1,-1, TIFF_DOUBLE,     FIELD_INTERGRAPH_MATRIX,
00035       TRUE,     TRUE,   <font class="stringliteral">"Intergraph TransformationMatrix"</font> },
00036     { TIFFTAG_GEOTRANSMATRIX,   -1,-1, TIFF_DOUBLE,     FIELD_GEOTRANSMATRIX,
00037       TRUE,     TRUE,   <font class="stringliteral">"GeoTransformationMatrix"</font> },
00038     { TIFFTAG_GEOTIEPOINTS,     -1,-1, TIFF_DOUBLE,     FIELD_GEOTIEPOINTS,
00039       TRUE,     TRUE,   <font class="stringliteral">"GeoTiePoints"</font> },
00040     { TIFFTAG_GEOKEYDIRECTORY,-1,-1, TIFF_SHORT,        FIELD_GEOKEYDIRECTORY,
00041       TRUE,     TRUE,   <font class="stringliteral">"GeoKeyDirectory"</font> },
00042     { TIFFTAG_GEODOUBLEPARAMS,  -1,-1, TIFF_DOUBLE,     FIELD_GEODOUBLEPARAMS,
00043       TRUE,     TRUE,   <font class="stringliteral">"GeoDoubleParams"</font> },
00044     { TIFFTAG_GEOASCIIPARAMS,   -1,-1, TIFF_ASCII,      FIELD_GEOASCIIPARAMS,
00045       TRUE,     FALSE,  <font class="stringliteral">"GeoASCIIParams"</font> },
00046 <font class="preprocessor">#ifdef JPL_TAG_SUPPORT</font>
00047 <font class="preprocessor"></font>    { TIFFTAG_JPL_CARTO_IFD,     1, 1, TIFF_LONG,       FIELD_JPL_CARTO_IFD,
00048       TRUE,     TRUE,   <font class="stringliteral">"JPL Carto IFD offset"</font> },  
00049 <font class="preprocessor">#endif</font>
00050 <font class="preprocessor"></font>};
00051 <font class="preprocessor">#define N(a)    (sizeof (a) / sizeof (a[0]))</font>
00052 <font class="preprocessor"></font>
00053 
00054 <font class="keyword">static</font> <font class="keywordtype">void</font>
00055 _XTIFFPrintDirectory(TIFF* tif, FILE* fd, <font class="keywordtype">long</font> flags)<font class="keyword"></font>
00056 <font class="keyword"></font>{
00057         xtiff *xt = XTIFFDIR(tif);
00058         XTIFFDirectory *xd = &amp;xt-&gt;xtif_dir;
00059         <font class="keywordtype">int</font> i,j,num;
00060 
00061         <font class="comment">/* call the inherited method */</font>
00062         <font class="keywordflow">if</font> (PARENT(xt,printdir))
00063                 (PARENT(xt,printdir))(tif,fd,flags);
00064 
00065         <font class="comment">/* XXX Add field printing here */</font>
00066 
00067         fprintf(fd,<font class="stringliteral">"--GeoTIFF Tags--\n"</font>);
00068 
00069         <font class="keywordflow">if</font> (TIFFFieldSet(tif,FIELD_GEOTIEPOINTS))
00070         {
00071                 num = xd-&gt;xd_geodimensions[GEO_NUM_TIEPOINT];
00072                 fprintf(fd, <font class="stringliteral">"  Geo Tiepoints:"</font>);
00073                 <font class="keywordflow">if</font> (num&gt;6) fprintf(fd,<font class="stringliteral">"\n    "</font>);
00074                 <font class="keywordflow">for</font> (i=0;i&lt;num;i+=6)
00075                 {
00076                    fprintf(fd,<font class="stringliteral">" ("</font>);
00077                    <font class="keywordflow">for</font> (j=0;j&lt;3;j++)
00078                         fprintf(fd, <font class="stringliteral">" %f"</font>, xd-&gt;xd_geotiepoints[i+j]);
00079                    fprintf(fd,<font class="stringliteral">")-&gt;("</font>);
00080                    <font class="keywordflow">for</font> (j=3;j&lt;6;j++)
00081                         fprintf(fd, <font class="stringliteral">" %f"</font>, xd-&gt;xd_geotiepoints[i+j]);
00082                    fprintf(fd,<font class="stringliteral">")\n"</font>);
00083                 }
00084         }
00085 
00086         <font class="keywordflow">if</font> (TIFFFieldSet(tif,FIELD_GEOPIXELSCALE))
00087         {
00088                 num = xd-&gt;xd_geodimensions[GEO_NUM_PIXELSCALE];
00089                 fprintf(fd, <font class="stringliteral">"  Geo Pixel Scale: ("</font>);
00090                 <font class="keywordflow">for</font> (j=0;j&lt;num;j++)
00091                    fprintf(fd, <font class="stringliteral">" %f"</font>, xd-&gt;xd_geopixelscale[j]);
00092                 fprintf(fd, <font class="stringliteral">" )\n"</font>);
00093         }
00094 
00095         <font class="keywordflow">if</font> (TIFFFieldSet(tif,FIELD_INTERGRAPH_MATRIX))
00096         {
00097                 num = xd-&gt;xd_geodimensions[GEO_NUM_IG_MATRIX];
00098                 fprintf(fd, <font class="stringliteral">"  Intergraph Transformation Matrix:\n"</font>);
00099                 <font class="keywordflow">for</font> (i=0;num&gt;3;num-=4)
00100                 {
00101                    <font class="keywordflow">for</font> (j=0;j&lt;4;j++)
00102                         fprintf(fd, <font class="stringliteral">" %8.2f"</font>, xd-&gt;xd_geomatrix[i++]);
00103                    fprintf(fd, <font class="stringliteral">"\n"</font>);
00104                 }
00105                 <font class="keywordflow">if</font> (num)
00106                 {
00107                    <font class="keywordflow">for</font> (j=0;j&lt;num;j++)
00108                         fprintf(fd, <font class="stringliteral">" %8.2f"</font>, xd-&gt;xd_geomatrix[i++]);
00109                    fprintf(fd, <font class="stringliteral">"\n"</font>);
00110                 }
00111         }
00112 
00113         <font class="keywordflow">if</font> (TIFFFieldSet(tif,FIELD_GEOTRANSMATRIX))
00114         {
00115                 num = xd-&gt;xd_geodimensions[GEO_NUM_MATRIX];
00116                 fprintf(fd, <font class="stringliteral">"  Geo Transformation Matrix:\n"</font>);
00117                 <font class="keywordflow">for</font> (i=0;i&lt;num;i+=4)
00118                 {
00119                    <font class="keywordflow">for</font> (j=0;j&lt;4;j++)
00120                         fprintf(fd, <font class="stringliteral">" %8.2f"</font>, xd-&gt;xd_geomatrix[i+j]);
00121                    fprintf(fd, <font class="stringliteral">"\n"</font>);
00122                 }
00123         }
00124 
00125         <font class="keywordflow">if</font> (TIFFFieldSet(tif,FIELD_GEOKEYDIRECTORY))
00126         {
00127                 num = xd-&gt;xd_geodimensions[GEO_NUM_DIR];
00128                 fprintf(fd, <font class="stringliteral">"  GeoKey Directory:"</font>);
00129                 <font class="keywordflow">if</font> (flags &amp; TIFFPRINT_GEOKEYDIRECTORY) 
00130                 {
00131                         fprintf(fd, <font class="stringliteral">"\n"</font>);
00132                         <font class="keywordflow">for</font> (i=0;i&lt;num;i+=4)
00133                         {
00134                            <font class="keywordflow">for</font> (j=0;j&lt;4;j++)
00135                                 fprintf(fd, <font class="stringliteral">"  %8hu"</font>, xd-&gt;xd_geokeydirectory[i+j]);
00136                            fprintf(fd, <font class="stringliteral">"\n"</font>);
00137                         }
00138                 } <font class="keywordflow">else</font>
00139                         fprintf(fd, <font class="stringliteral">"(present)\n"</font>);
00140 
00141         }
00142 
00143         <font class="keywordflow">if</font> (TIFFFieldSet(tif,FIELD_GEODOUBLEPARAMS))
00144         {
00145                 num = xd-&gt;xd_geodimensions[GEO_NUM_DOUBLE];
00146                 fprintf(fd, <font class="stringliteral">"  GeoKey Double Params:"</font>);
00147                 <font class="keywordflow">if</font> (flags &amp; TIFFPRINT_GEOKEYPARAMS) 
00148                 {
00149                         fprintf(fd, <font class="stringliteral">"\n"</font>);
00150                         <font class="keywordflow">for</font> (i=0;i&lt;num;i++) 
00151                                 fprintf(fd, <font class="stringliteral">"  %8.2f"</font>, xd-&gt;xd_geodoubleparams[i]);
00152                         fprintf(fd, <font class="stringliteral">"\n"</font>);
00153                 } <font class="keywordflow">else</font>
00154                         fprintf(fd, <font class="stringliteral">"(present)\n"</font>);
00155 
00156         }
00157 
00158         <font class="keywordflow">if</font> (TIFFFieldSet(tif,FIELD_GEOASCIIPARAMS))
00159         {
00160                 <font class="keywordflow">if</font> (flags &amp; TIFFPRINT_GEOKEYPARAMS) 
00161                 {
00162                         _TIFFprintAsciiTag(fd,<font class="stringliteral">"GeoKey ASCII Parameters"</font>,
00163                                  xd-&gt;xd_geoasciiparams);
00164                 } <font class="keywordflow">else</font>
00165                         fprintf(fd, <font class="stringliteral">"  GeoKey ASCII Parameters:(present)\n"</font>);
00166         }
00167 }
00168 
00169 <font class="keyword">static</font> <font class="keywordtype">int</font>
00170 _XTIFFVSetField(TIFF* tif, ttag_t tag, va_list ap)<font class="keyword"></font>
00171 <font class="keyword"></font>{
00172         xtiff *xt = XTIFFDIR(tif);
00173         XTIFFDirectory* xd = &amp;xt-&gt;xtif_dir;
00174         <font class="keywordtype">int</font> status = 1;
00175         uint16 num;
00176 
00177         <font class="comment">/* va_start is called by the calling routine */</font>
00178         
00179         <font class="keywordflow">switch</font> (tag) {
00180                 <font class="comment">/* XXX put extended tags here */</font>
00181         <font class="keywordflow">case</font> TIFFTAG_GEOKEYDIRECTORY:
00182                 xd-&gt;xd_geodimensions[GEO_NUM_DIR] = (uint16) va_arg(ap, <font class="keywordtype">int</font>);
00183                 _TIFFsetShortArray(&amp;xd-&gt;xd_geokeydirectory, va_arg(ap, uint16*),
00184                         (<font class="keywordtype">long</font>) xd-&gt;xd_geodimensions[GEO_NUM_DIR]);
00185                 <font class="keywordflow">break</font>;
00186         <font class="keywordflow">case</font> TIFFTAG_GEODOUBLEPARAMS:
00187                 xd-&gt;xd_geodimensions[GEO_NUM_DOUBLE] = (uint16) va_arg(ap, <font class="keywordtype">int</font>);
00188                 _TIFFsetDoubleArray(&amp;xd-&gt;xd_geodoubleparams, va_arg(ap, <font class="keywordtype">double</font>*),
00189                         (<font class="keywordtype">long</font>) xd-&gt;xd_geodimensions[GEO_NUM_DOUBLE]);
00190                 <font class="keywordflow">break</font>;
00191         <font class="keywordflow">case</font> TIFFTAG_GEOTIEPOINTS:
00192                 xd-&gt;xd_geodimensions[GEO_NUM_TIEPOINT] = (uint16) va_arg(ap, <font class="keywordtype">int</font>);
00193                 _TIFFsetDoubleArray(&amp;xd-&gt;xd_geotiepoints, va_arg(ap, <font class="keywordtype">double</font>*),
00194                         (<font class="keywordtype">long</font>) xd-&gt;xd_geodimensions[GEO_NUM_TIEPOINT]);
00195                 <font class="keywordflow">break</font>;
00196         <font class="keywordflow">case</font> TIFFTAG_GEOTRANSMATRIX:
00197                 xd-&gt;xd_geodimensions[GEO_NUM_MATRIX] = (uint16) va_arg(ap, <font class="keywordtype">int</font>);
00198                 _TIFFsetDoubleArray(&amp;xd-&gt;xd_geomatrix, va_arg(ap, <font class="keywordtype">double</font>*),
00199                         (<font class="keywordtype">long</font>) xd-&gt;xd_geodimensions[GEO_NUM_MATRIX]);
00200                 <font class="keywordflow">break</font>;
00201         <font class="keywordflow">case</font> TIFFTAG_INTERGRAPH_MATRIX:
00202                 num = (uint16) va_arg(ap, <font class="keywordtype">int</font>);
00203                 xd-&gt;xd_geodimensions[GEO_NUM_IG_MATRIX] = num;
00204                 _TIFFsetDoubleArray(&amp;xd-&gt;xd_intergraph_matrix, va_arg(ap, <font class="keywordtype">double</font>*),
00205                         (<font class="keywordtype">long</font>) num);
00206                 <font class="comment">/* For backward compatibility; note that we only</font>
00207 <font class="comment">                 * allow the Intergraph tag to affect the GeoTIFF tag</font>
00208 <font class="comment">                 * if the count is correct (Intergraph's version uses 17).</font>
00209 <font class="comment">                 */</font>
00210                 <font class="keywordflow">if</font> (!TIFFFieldSet(tif,FIELD_GEOTRANSMATRIX) &amp;&amp; num==16)
00211                         TIFFSetField(tif,TIFFTAG_GEOTRANSMATRIX,
00212                                 num, xd-&gt;xd_intergraph_matrix);
00213                 <font class="keywordflow">break</font>;
00214         <font class="keywordflow">case</font> TIFFTAG_GEOPIXELSCALE:
00215                 xd-&gt;xd_geodimensions[GEO_NUM_PIXELSCALE] = (uint16) va_arg(ap, <font class="keywordtype">int</font>);
00216                 _TIFFsetDoubleArray(&amp;xd-&gt;xd_geopixelscale, va_arg(ap, <font class="keywordtype">double</font>*),
00217                         (<font class="keywordtype">long</font>) xd-&gt;xd_geodimensions[GEO_NUM_PIXELSCALE]);
00218                 <font class="keywordflow">break</font>;
00219         <font class="keywordflow">case</font> TIFFTAG_GEOASCIIPARAMS:
00220                 _TIFFsetString(&amp;xd-&gt;xd_geoasciiparams, va_arg(ap, <font class="keywordtype">char</font>*));
00221                 <font class="keywordflow">break</font>;
00222 <font class="preprocessor">#ifdef JPL_TAG_SUPPORT</font>
00223 <font class="preprocessor"></font>        <font class="keywordflow">case</font> TIFFTAG_JPL_CARTO_IFD:
00224                 xd-&gt;xd_jpl_ifd_offset = va_arg(ap, uint32);
00225                 <font class="keywordflow">break</font>;
00226 <font class="preprocessor">#endif</font>
00227 <font class="preprocessor"></font>        <font class="keywordflow">default</font>:
00228                 <font class="comment">/* call the inherited method */</font>
00229                 <font class="keywordflow">return</font> (PARENT(xt,vsetfield))(tif,tag,ap);
00230         }
00231         <font class="keywordflow">if</font> (status) {
00232                 <font class="comment">/* we have to override the print method here,</font>
00233 <font class="comment">                 * after the compression tags have gotten to it.</font>
00234 <font class="comment">                 * This makes sense because the only time we would</font>
00235 <font class="comment">                 * need the extended print method is if an extended</font>
00236 <font class="comment">                 * tag is set by either the reader or writer.</font>
00237 <font class="comment">                 */</font>
00238                 <font class="keywordflow">if</font> (!(xt-&gt;xtif_flags &amp; XTIFFP_PRINT))
00239                 {
00240                         PARENT(xt,printdir) =  TIFFMEMBER(tif,printdir);
00241                         TIFFMEMBER(tif,printdir) = _XTIFFPrintDirectory;
00242                         xt-&gt;xtif_flags |= XTIFFP_PRINT;
00243                 }
00244                 TIFFSetFieldBit(tif, _TIFFFieldWithTag(tif, tag)-&gt;field_bit);
00245                 tif-&gt;tif_flags |= TIFF_DIRTYDIRECT;
00246         }
00247         va_end(ap);
00248         <font class="keywordflow">return</font> (status);
00249 }
00250 
00251 
00252 <font class="keyword">static</font> <font class="keywordtype">int</font>
00253 _XTIFFVGetField(TIFF* tif, ttag_t tag, va_list ap)<font class="keyword"></font>
00254 <font class="keyword"></font>{
00255         xtiff *xt = XTIFFDIR(tif);
00256         XTIFFDirectory* xd = &amp;xt-&gt;xtif_dir;
00257 
00258         <font class="keywordflow">switch</font> (tag) {
00259                 <font class="comment">/* XXX insert your tags here */</font>
00260         <font class="keywordflow">case</font> TIFFTAG_GEOKEYDIRECTORY:
00261                 *va_arg(ap, uint16*) = xd-&gt;xd_geodimensions[GEO_NUM_DIR];
00262                 *va_arg(ap, uint16**) = xd-&gt;xd_geokeydirectory;
00263                 <font class="keywordflow">break</font>;
00264         <font class="keywordflow">case</font> TIFFTAG_GEODOUBLEPARAMS:
00265                 *va_arg(ap, uint16*) = xd-&gt;xd_geodimensions[GEO_NUM_DOUBLE];
00266                 *va_arg(ap, <font class="keywordtype">double</font>**) = xd-&gt;xd_geodoubleparams;
00267                 <font class="keywordflow">break</font>;
00268         <font class="keywordflow">case</font> TIFFTAG_GEOTIEPOINTS:
00269                 *va_arg(ap, uint16*) = xd-&gt;xd_geodimensions[GEO_NUM_TIEPOINT];
00270                 *va_arg(ap, <font class="keywordtype">double</font>**) = xd-&gt;xd_geotiepoints;
00271                 <font class="keywordflow">break</font>;
00272         <font class="keywordflow">case</font> TIFFTAG_GEOTRANSMATRIX:
00273                 *va_arg(ap, uint16*) = xd-&gt;xd_geodimensions[GEO_NUM_MATRIX];
00274                 *va_arg(ap, <font class="keywordtype">double</font>**) = xd-&gt;xd_geomatrix;
00275                 <font class="keywordflow">break</font>;
00276         <font class="keywordflow">case</font> TIFFTAG_INTERGRAPH_MATRIX:
00277                 *va_arg(ap, uint16*) = xd-&gt;xd_geodimensions[GEO_NUM_IG_MATRIX];
00278                 *va_arg(ap, <font class="keywordtype">double</font>**) = xd-&gt;xd_intergraph_matrix;
00279                 <font class="keywordflow">break</font>;
00280         <font class="keywordflow">case</font> TIFFTAG_GEOPIXELSCALE:
00281                 *va_arg(ap, uint16*) = xd-&gt;xd_geodimensions[GEO_NUM_PIXELSCALE];
00282                 *va_arg(ap, <font class="keywordtype">double</font>**) = xd-&gt;xd_geopixelscale;
00283                 <font class="keywordflow">break</font>;
00284         <font class="keywordflow">case</font> TIFFTAG_GEOASCIIPARAMS:
00285                 *va_arg(ap, <font class="keywordtype">char</font>**) = xd-&gt;xd_geoasciiparams;
00286                 <font class="keywordflow">break</font>;
00287 <font class="preprocessor">#ifdef JPL_TAG_SUPPORT</font>
00288 <font class="preprocessor"></font>        <font class="keywordflow">case</font> TIFFTAG_JPL_CARTO_IFD:
00289                 *va_arg(ap, uint32*) = xd-&gt;xd_jpl_ifd_offset;
00290                 <font class="keywordflow">break</font>;
00291 <font class="preprocessor">#endif</font>
00292 <font class="preprocessor"></font>        <font class="keywordflow">default</font>:
00293                 <font class="comment">/* return inherited method */</font>
00294                 <font class="keywordflow">return</font> (PARENT(xt,vgetfield))(tif,tag,ap);
00295         }
00296         <font class="keywordflow">return</font> (1);
00297 }
00298 
00299 <font class="preprocessor">#define CleanupField(member) {          \</font>
00300 <font class="preprocessor">    if (xd-&gt;member) {                   \</font>
00301 <font class="preprocessor">        _TIFFfree(xd-&gt;member);          \</font>
00302 <font class="preprocessor">        xd-&gt;member = 0;                 \</font>
00303 <font class="preprocessor">    }                                   \</font>
00304 <font class="preprocessor">}</font>
00305 <font class="preprocessor"></font><font class="comment">/*</font>
00306 <font class="comment"> * Release storage associated with a directory.</font>
00307 <font class="comment"> */</font>
00308 <font class="keyword">static</font> <font class="keywordtype">void</font>
00309 _XTIFFFreeDirectory(xtiff* xt)<font class="keyword"></font>
00310 <font class="keyword"></font>{
00311         XTIFFDirectory* xd = &amp;xt-&gt;xtif_dir;
00312 
00313         <font class="comment">/* </font>
00314 <font class="comment">         *  Purge all allocated memory except</font>
00315 <font class="comment">         *  for the xtiff directory itself. This includes</font>
00316 <font class="comment">         *  all fields that require a _TIFFsetXXX call in</font>
00317 <font class="comment">         *  _XTIFFVSetField().</font>
00318 <font class="comment">         */</font>
00319         
00320         CleanupField(xd_geokeydirectory);
00321         CleanupField(xd_geodoubleparams);
00322         CleanupField(xd_geoasciiparams);
00323         CleanupField(xd_geomatrix);
00324         CleanupField(xd_geopixelscale);
00325         CleanupField(xd_geotiepoints);
00326         CleanupField(xd_intergraph_matrix);
00327         
00328 }
00329 <font class="preprocessor">#undef CleanupField</font>
00330 <font class="preprocessor"></font>
00331 <font class="keyword">static</font> <font class="keywordtype">void</font> _XTIFFLocalDefaultDirectory(TIFF *tif)<font class="keyword"></font>
00332 <font class="keyword"></font>{
00333         xtiff *xt = XTIFFDIR(tif);
00334 
00335         <font class="comment">/* Install the extended Tag field info */</font>
00336         _TIFFMergeFieldInfo(tif, xtiffFieldInfo, N(xtiffFieldInfo));
00337 
00338         <font class="comment">/*</font>
00339 <font class="comment">         *  free up any dynamically allocated arrays</font>
00340 <font class="comment">         *  before the new directory is read in.</font>
00341 <font class="comment">         */</font>
00342          
00343         _XTIFFFreeDirectory(xt);        
00344         _TIFFmemset(xt,0,<font class="keyword">sizeof</font>(xtiff));
00345 
00346         <font class="comment">/* Override the tag access methods */</font>
00347 
00348         PARENT(xt,vsetfield) =  TIFFMEMBER(tif,vsetfield);
00349         TIFFMEMBER(tif,vsetfield) = _XTIFFVSetField;
00350         PARENT(xt,vgetfield) =  TIFFMEMBER(tif,vgetfield);
00351         TIFFMEMBER(tif,vgetfield) = _XTIFFVGetField;
00352 
00353         <font class="comment">/* </font>
00354 <font class="comment">         * XXX Set up any default values here.</font>
00355 <font class="comment">         */</font>
00356         
00357         <font class="comment">/* NO DEFAULT GEOTIFF Values !*/</font>
00358 
00359 }
00360 
00361 
00362 
00363 <font class="comment">/**********************************************************************</font>
00364 <font class="comment"> *    Nothing below this line should need to be changed.</font>
00365 <font class="comment"> **********************************************************************/</font>
00366 
00367 <font class="keyword">static</font> TIFFExtendProc _ParentExtender;
00368 
00369 <font class="comment">/*</font>
00370 <font class="comment"> *  This is the callback procedure, and is</font>
00371 <font class="comment"> *  called by the DefaultDirectory method</font>
00372 <font class="comment"> *  every time a new TIFF directory is opened.</font>
00373 <font class="comment"> */</font>
00374 
00375 <font class="keyword">static</font> <font class="keywordtype">void</font>
00376 _XTIFFDefaultDirectory(TIFF *tif)<font class="keyword"></font>
00377 <font class="keyword"></font>{
00378         xtiff *xt;
00379         
00380         <font class="comment">/* Allocate Directory Structure if first time, and install it */</font>
00381         <font class="keywordflow">if</font> (!(tif-&gt;tif_flags &amp; XTIFF_INITIALIZED))
00382         {
00383                 xt = _TIFFmalloc(<font class="keyword">sizeof</font>(xtiff));
00384                 <font class="keywordflow">if</font> (!xt)
00385                 {
00386                         <font class="comment">/* handle memory allocation failure here ! */</font>
00387                         <font class="keywordflow">return</font>;
00388                 }
00389                 _TIFFmemset(xt,0,<font class="keyword">sizeof</font>(xtiff));
00390                 <font class="comment">/*</font>
00391 <font class="comment">                 * Install into TIFF structure.</font>
00392 <font class="comment">                 */</font>
00393                 TIFFMEMBER(tif,clientdir) = (tidata_t)xt;
00394                 tif-&gt;tif_flags |= XTIFF_INITIALIZED; <font class="comment">/* dont do this again! */</font>
00395         }
00396         
00397         <font class="comment">/* set up our own defaults */</font>
00398         _XTIFFLocalDefaultDirectory(tif);
00399 
00400         <font class="comment">/* Since an XTIFF client module may have overridden</font>
00401 <font class="comment">         * the default directory method, we call it now to</font>
00402 <font class="comment">         * allow it to set up the rest of its own methods.</font>
00403 <font class="comment">         */</font>
00404 
00405         <font class="keywordflow">if</font> (_ParentExtender) 
00406                 (*_ParentExtender)(tif);
00407 
00408 }
00409 
00410 <font class="comment">/*</font>
00411 <font class="comment"> *  XTIFF Initializer -- sets up the callback</font>
00412 <font class="comment"> *   procedure for the TIFF module.</font>
00413 <font class="comment"> */</font>
00414 
00415 <font class="keyword">static</font>
00416 <font class="keywordtype">void</font> _XTIFFInitialize(<font class="keywordtype">void</font>)<font class="keyword"></font>
00417 <font class="keyword"></font>{
00418         <font class="keyword">static</font> <font class="keywordtype">int</font> first_time=1;
00419         
00420         <font class="keywordflow">if</font> (! first_time) <font class="keywordflow">return</font>; <font class="comment">/* Been there. Done that. */</font>
00421         first_time = 0;
00422         
00423         <font class="comment">/* Grab the inherited method and install */</font>
00424         _ParentExtender = TIFFSetTagExtender(_XTIFFDefaultDirectory);
00425 }
00426 
00427 
00450 TIFF*
00451 <a class="code" href="xtiffio_h.html#a9">XTIFFOpen</a>(<font class="keyword">const</font> <font class="keywordtype">char</font>* name, <font class="keyword">const</font> <font class="keywordtype">char</font>* mode)<font class="keyword"></font>
00452 <font class="keyword"></font>{
00453         TIFF *tif;
00454 
00455         <font class="comment">/* Set up the callback */</font>
00456         _XTIFFInitialize();     
00457         
00458         <font class="comment">/* Open the file; the callback will set everything up</font>
00459 <font class="comment">         */</font>
00460         tif = TIFFOpen(name, mode);
00461         <font class="keywordflow">if</font> (!tif) <font class="keywordflow">return</font> tif;
00462         
00463         <font class="keywordflow">return</font> tif;
00464 }
00465 
00466 TIFF*
00467 XTIFFFdOpen(<font class="keywordtype">int</font> fd, <font class="keyword">const</font> <font class="keywordtype">char</font>* name, <font class="keyword">const</font> <font class="keywordtype">char</font>* mode)<font class="keyword"></font>
00468 <font class="keyword"></font>{
00469         TIFF *tif;
00470 
00471         <font class="comment">/* Set up the callback */</font>
00472         _XTIFFInitialize();     
00473 
00474         <font class="comment">/* Open the file; the callback will set everything up</font>
00475 <font class="comment">         */</font>
00476         tif = TIFFFdOpen(fd, name, mode);
00477         <font class="keywordflow">if</font> (!tif) <font class="keywordflow">return</font> tif;
00478         
00479         <font class="keywordflow">return</font> tif;
00480 }
00481 
00492 <font class="keywordtype">void</font>
00493 <a class="code" href="xtiffio_h.html#a11">XTIFFClose</a>(TIFF *tif)<font class="keyword"></font>
00494 <font class="keyword"></font>{
00495         xtiff *xt = XTIFFDIR(tif);
00496         
00497         <font class="comment">/* call inherited function first */</font>
00498         TIFFClose(tif);
00499         
00500         <font class="comment">/* Free up extended allocated memory */</font>
00501         _XTIFFFreeDirectory(xt);
00502         _TIFFfree(xt);
00503 }
</div></pre><hr><address><small>Generated at Sun Mar 4 22:25:49 2001 for libgeotiff by
<a href="http://www.stack.nl/~dimitri/doxygen/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.3-20001105 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2000</small></address>
</body>
</html>
